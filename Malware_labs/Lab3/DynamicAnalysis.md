# Lab 3: Dynamic Analysis
## Lab 3-1
### Questions
1. What are this malware’s imports and strings?
2. What are the malware’s host-based indicators?
3. Are there any useful network-based signatures for this malware? If so, what are they?
### Imports and strings
Checking PEiD to see if the binary is packed.

![lab03-01 peid packed](../../Images/lab03-01_packed.png)

The binary does appear to be packed with PEncyrpt 3.1

Checking PEStudio for imports and strings:

![lab03-01 pestudio imports](../../Images/lab03-01_imports.png)

![lab03-01 pestudio strings1](../../Images/lab03-01_strings1.png)

![lab03-01 pestudio strings2](../../Images/lab03-01_strings2.png)

The lack of imports is another indicator that this binary was packed. Some especially interesting strings include: CONNECT, HTTP, www.practicalmalwareanalysis.com, registry keys like Software\Microsoft\Current\Verson\Run, admin, VideoDriver, and WinMX32. 


### Host-based indicators

Looking into the strings we noticed a few registry keys including `SOFTWARE\Microsoft\Windows\CurrentVersion\Run` which means the program is trying to get persistance. The `vmx32to64.exe` is more likely the name of the malware.

### Network-based indicators

Looking at [CONNECT](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/CONNECT) for http, we can see that it is an HTTP method for creating two-way communications as a tunnel. The URL that is present in the strings is www[.]practicalmalwareanalysis[.]com

### Conclusions

## Lab 3-2
### Questions
1. How can you get this malware to install itself?
2. How would you get this malware to run after installation?
3. How can you find the process under which this malware is running?
4. Which filters could you set in order to use procmon to glean information?
5. What are the malware’s host-based indicators?
6. Are there any useful network-based signatures for this malware?
### Imports and Strings
![lab03-02 exports](../../Images/lab03-02_exports.png)

### Installation

Looking at the exports in PEStudio we see ordinal values followed with the names. We are assuming the name Install will help us install the malware. 

We also noticed that the properties of the executable file indicate that `installA` can be used to install the program.

![lab03-02 process explorer](../../Images/lab03-02_procexp.png)

Before running any malware, we will take a shot with RegShot and start ProcessExplorer as well as Procmon to record what happens after the program is installed.

![lab03-02 Regshot](../../Images/lab03-02_Regshot2.PNG)

### Running

We ran the following command

`C:\>rundll32.exe Lab03-02.dll, installA`

Taking another shot after installing the malware, we are able to compare added and removed keys/values. This indicates that a IPRIP service needs to be started. This also shows the executable file that the `.dll` file depends on to launch is `svchost.exe`. 

![lab03-02 Regshot](../../Images/lab03-02_Regshot.PNG)


### Network-based indicators

The textbook recommends faking a network with ApateDNS and Netcat. However, ApateDNS is not easily found for windows XP. We are instead attempting to fake a network with FakeNet. 

We can then run the malware by starting the service with the following command

`C:\>net start IPRIP`

After starting the service, we first look at Process Explorer. We were able to narrow down the results by searching for the file name `Lab03-02.dll`

![lab03-02 ProcessExplorer](../../Images/lab03-02_ProcessExplorer.png)

This indicated that the process ID for this service was `984`. This information can be used to filter results in other programs later.

![lab03-02 ProcessExplorer](../../Images/lab03-02_ProcessExplorer2.png)

Then we will take a look at the network traffic recorded on our fake network. We can see that a DNS query for `practicalmalwareanalysis.com` was made. This makes sense as this was previously noted as a suspicious string in the static analysis. The malware also makes a GET request to `serve.html` on port 80.  

![lab03-02 FakeNet1](../../Images/lab03-02_FakeNet.png)

![lab03-02 FakeNet2](../../Images/lab03-02_FakeNet1.png)



The malware service was started with `C:\>net start IPRIP`. An attempt to stop this service was made with `C:\>net stop IPRIP`. It appeared to be succesful as there was no more network traffic recorded. Although it indicated that the service was stopped succesfully, I was suspicious of this. Previously, the `sleep` string was found in the file. A lack of network traffic does not necessarily indicate that the malware has been stopped. Using `sleep` is a tricky way to hide from analysts. 

After watching network traffic for a few minutes, another round of GET requests were made. The malware is still running and attempting to access the network. 

![lab03-02 FakeNet3](../../Images/lab03-02_FakeNet2.png)


### Host-based indicators

There were 28,145 events that occured in the short time that I was capturing with Procmon. To narrow these results down to a reasonable amount, I filtered with the PID obtained from ProcessExplorer: `984`. This specific process appears to be making repeated `CreateFile`, `QueryFileInternalInformationFile`, `CloseFile`, `QueryOpen` operations. 

![lab03-02 Procmon](../../Images/lab03-02_Procmon.png)



### Network-based Signatures

Network-based signatures can be gleaned from network traffic found on FakeNet. Because the malware is making `GET` requests to `serve.html` on port 80 and DNS Queries to `practicalmalwareanalysis.com`, these can be used as network signatures to create YARA rules. Another network signature could possibly be `Windows XP 6.11`. This User Agent shows up with the name of the VirtualMachine it is running in. 

![lab03-02 FakeNet Network Signatures](../../Images/lab03-02_FakeNet4.png)

### Conclusions

## Lab 3-3

## Lab 3-4


